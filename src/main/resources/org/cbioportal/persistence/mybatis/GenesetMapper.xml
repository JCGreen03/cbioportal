<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.GenesetMapper">

    <sql id="select">
        GENESET.ID AS "${prefix}internalId",
        GENESET.EXTERNAL_ID AS "${prefix}genesetId",
        GENESET.NAME as "${prefix}name",
        GENESET.DESCRIPTION as "${prefix}description",
        GENESET.REF_LINK as "${prefix}refLink"
    </sql>

    <select id="getGenesets" resultType="org.cbioportal.model.Geneset">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM GENESET
        <if test="sortBy != null and projection != 'ID'">
            ORDER BY "${sortBy}" ${direction}
        </if>
        <if test="projection == 'ID'">
            ORDER BY GENESET.EXTERNAL_ID ASC
        </if>
        <if test="limit != null and limit != 0">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <select id="getMetaGenesets" resultType="org.cbioportal.model.meta.BaseMeta">
        SELECT
        COUNT(*) AS totalCount
        FROM GENESET
    </select>

    <select id="getGenesetByGenesetId" resultType="org.cbioportal.model.Geneset">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM GENESET
        WHERE GENESET.EXTERNAL_ID = #{genesetId}
    </select>
    
    <select id="fetchGenesets" resultType="org.cbioportal.model.Geneset">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM GENESET
        WHERE GENESET.EXTERNAL_ID IN
        <foreach item="item" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
        ORDER BY GENESET.EXTERNAL_ID ASC
    </select>

    <select id="getGenesByGenesetId" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="org.cbioportal.persistence.mybatis.GeneMapper.select">
            <property name="prefix" value=""/>
        </include>
        FROM GENE
        join GENESET_GENE ON GENE.ENTREZ_GENE_ID = GENESET_GENE.ENTREZ_GENE_ID
	    join GENESET on GENESET.ID = GENESET_GENE.GENESET_ID
        WHERE
         GENESET.EXTERNAL_ID = #{genesetId}
    </select>
    
    <select id="getGenesetVersion" resultType="String">
        SELECT GENESET_VERSION
        FROM INFO
    </select>

</mapper>
